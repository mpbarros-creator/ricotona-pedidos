<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <base href="https://mpbarros-creator.github.io/ricotona-pedidos/">
  <title>Historial de Pedidos ‚Äî Ricotona</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:#121212;color:#f5f5f5;padding:12px}

    header{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:15px}
    header button{padding:8px 14px;font-size:15px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;color:#fff}
    .blue{background:#0a6cff}
    .green{background:#2e7d32}

    .item{background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:10px;margin-bottom:10px}
    .item h3{font-size:18px;color:#ff9800;margin-bottom:8px}
    .fila{display:flex;flex-wrap:wrap;gap:12px;font-size:14px;color:#ddd;margin-bottom:6px}
    .fila b{color:#ccc}
    .botones{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .botones button{padding:6px 10px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;color:#fff}
    .btn-pdf{background:#ff9800;color:#111}
    .btn-ver{background:#0a6cff}
    .btn-del{background:#dc3545}

    .detalle{display:none;margin-top:10px;background:#1a1a1a;padding:8px;border-radius:4px}
    .detalle p{margin:4px 0;font-size:13px}
    .detalle table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;background:#1a1a1a}
    .detalle th,.detalle td{border:1px solid #333;padding:5px;text-align:center}
    .detalle thead{background:#2a2a2a;color:#ff9800}
    .detalle tbody tr:nth-child(even){background:#181818}
  </style>
</head>
<body>
  <header>
    <button class="blue" id="btn-recargar">‚Üª Recargar</button>
    <button class="green" id="btn-volver">‚Üê Volver a la Nota</button>
  </header>

  <div id="lista-pedidos"></div>

  <!-- Helpers de almacenamiento compartidos -->
  <script>
    window.STORAGE_KEY = 'ricotona_pedidos_v1';
    window.RicoStore = {
      get() {
        try { return JSON.parse(localStorage.getItem(window.STORAGE_KEY) || '[]'); }
        catch { return []; }
      },
      set(arr) {
        localStorage.setItem(window.STORAGE_KEY, JSON.stringify(arr));
      }
    };
  </script>

  <script>
    const { jsPDF } = window.jspdf;

    // üëâ PON√â AQU√ç TU URL DE APPS SCRIPT (la que devuelve: ok drive-log-v2)
    const MAIL_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxGi2wS_zwXIWwxQLhQPrqW3s-UPpdNRBlYGDyt5WERObd5rZ0sCPnrA76CmpyBRo9e/exec';

    // Utilidad para nombre de archivo
    const slug = s => String(s || '')
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-zA-Z0-9]+/g,'_').replace(/^_+|_+$/g,'')
      .slice(0,60);

    function getPedidos(){ return window.RicoStore.get(); }
    function setPedidos(a){ window.RicoStore.set(a); }

    function cargarPedidos(){ renderPedidos(); }
    document.getElementById('btn-recargar')?.addEventListener('click', cargarPedidos);
    document.getElementById('btn-volver')?.addEventListener('click', () => { location.href = 'index.html'; });

    document.addEventListener('DOMContentLoaded', cargarPedidos);

    function renderPedidos(){
      const cont = document.getElementById('lista-pedidos');
      cont.innerHTML = '';
      const pedidos = getPedidos();

      if(!pedidos.length){
        cont.innerHTML = '<p style="color:#ccc">No hay pedidos guardados.</p>';
        return;
      }

      pedidos.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        const fecha = p.fechaPedido || p['fecha-pedido'] || '';
        const cliente = p.cliente || 'Sin cliente';

        div.innerHTML = `
          <h3>Pedido de ${cliente}</h3>
          <div class="fila">
            <div><b>Fecha:</b> ${fecha || '-'}</div>
            <div><b>Vendedor:</b> ${p.vendedor || '-'}</div>
            <div><b>Transporte:</b> ${p.transporte || '-'}</div>
            <div><b>Entrega:</b> ${p.fechaEntrega || p['fecha-entrega'] || '-'}</div>
            <div><b># Productos:</b> ${(p.productos||[]).length}</div>
          </div>
          <div class="botones">
            <button class="btn-ver"  onclick="toggleDetalle(${idx})">Ver</button>
            <button class="btn-pdf"  onclick="exportarPDF(${idx})">Exportar PDF</button>
            <button class="btn-del"  onclick="borrarPedido(${idx})">Borrar</button>
          </div>
          <div class="detalle" id="det-${idx}">
            <p><b>Condiciones:</b> ${p.condiciones || '-'}</p>
            <p><b>Observaciones:</b> ${p.observaciones || '-'}</p>
            <table>
              <thead>
                <tr>
                  <th>Descripci√≥n</th><th>Marca</th><th>Peso</th><th>C√≥digo</th>
                  <th>Col</th><th>Interno</th><th>Dcto%</th><th>Cant</th>
                  <th>Precio</th><th>Desc.</th><th>Sub total</th>
                </tr>
              </thead>
              <tbody>
                ${(p.productos||[]).map(it => `
                  <tr>
                    <td>${it.descripcion||''}</td>
                    <td>${it.marca||''}</td>
                    <td>${it.peso||''}</td>
                    <td>${it.codigo||''}</td>
                    <td>${it.coll||''}</td>
                    <td>${it.interno||''}</td>
                    <td>${it.dto||''}</td>
                    <td>${it.cantidad||''}</td>
                    <td>${it.precio||''}</td>
                    <td>${it.descuento||''}</td>
                    <td>${it.subtotal||''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        cont.appendChild(div);
      });
    }

    function toggleDetalle(i){
      const el = document.getElementById('det-'+i);
      if(!el) return;
      el.style.display = (el.style.display==='block' ? 'none' : 'block');
    }

    async function exportarPDF(i){
      const pedidos = getPedidos();
      const pedido  = pedidos[i];
      if(!pedido) return alert('Pedido no encontrado');

      const hoy = new Date().toISOString().slice(0,10);
      const filename = `pedido_${slug(pedido.cliente||'sin_cliente')}_${hoy}.pdf`;

      const doc = new jsPDF({ unit:'pt', format:'a4' });
      doc.setFontSize(16);
      doc.text('NOTA DE PEDIDO', 40, 40);
      doc.setFontSize(11);
      doc.text(`Cliente: ${pedido.cliente||'-'}`, 40, 62);
      doc.text(`Fecha Pedido: ${pedido.fechaPedido || pedido['fecha-pedido'] || hoy}`, 40, 78);

      const head = [['Descripci√≥n','Marca','Peso','C√≥digo','Col','Interno','Dcto%','Cant','Precio','Desc.','Sub']];
      const body = (pedido.productos||[]).map(p => [
        p.descripcion||'', p.marca||'', p.peso||'', p.codigo||'',
        p.coll||'', p.interno||'', p.dto||'', p.cantidad||'',
        p.precio||'', p.descuento||'', p.subtotal||''
      ]);

      doc.autoTable({
        head, body,
        startY: 100,
        styles: { fontSize: 9, cellPadding: 3 },
        headStyles: { fillColor: [230,230,230], textColor: 20 }
      });

      // Guardar local (descarga)
      doc.save(filename);

      // Enviar a Apps Script
      try {
        const dataUri = doc.output('datauristring');
        const base64  = (dataUri.split(',')[1]||'');
        const meta    = {
          cliente: pedido.cliente||'',
          fecha:   pedido.fechaPedido || pedido['fecha-pedido'] || hoy,
          vendedor: pedido.vendedor||'',
          transporte: pedido.transporte||'',
          condiciones: pedido.condiciones||'',
          fechaEntrega: pedido.fechaEntrega || pedido['fecha-entrega'] || '',
          numProductos: (pedido.productos||[]).length
        };

        const res = await fetch(MAIL_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename, pdfBase64: base64, meta })
        });
        const json = await res.json().catch(()=>({}));
        if (!json || json.ok !== true) throw new Error('respuesta_invalida');
        alert('Enviado y guardado en Drive ‚úîÔ∏è');
      } catch (e) {
        console.error(e);
        alert('Error de env√≠o al correo');
      }
    }

    function borrarPedido(i){
      if(!confirm('¬øEliminar este pedido?')) return;
      const arr = getPedidos();
      arr.splice(i,1);
      setPedidos(arr);
      renderPedidos();
    }
  </script>
</body>
</html>
